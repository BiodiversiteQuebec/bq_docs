---
title: Geoparquet pour Atlas 
---

La base de données Atlas est sauvegardée de façon régulière en format Parquet. Voici les instructions pour intéragir avec le fichier parquet entreposé sur l'infonuagique de l'Alliance des ressources numériques. 


Avant de continuer, veuillez installer les packages suivant. 
```r
install.packages(c('dplyr','duckdb','duckdbfs'))
```

Ensuite, à chaque fois que vous voulez accéder aux données, vous devez d'abord executer la ligne suivante pour charger les fonctions nécessaires. 
```r
source("http://atlas.biodiversite-quebec.ca/bq-atlas-parquet.R")
```

### Connexion à distance au fichier GeoParquet. 

L'objet atlas_dates contient les dates de sauvegarde des fichiers disponibles. 

```r
atlas_dates
```

Établir la connexion à la version la plus récente des données Atlas. 
```r
atlas_rem <- atlas_remote(tail(atlas_dates$dates,n=1))
```

Obtenir le nombre d'observations de chacune des espèces présentes dans Atlas et trier par nombre d'observations décroissant. Notez que cette requête ne chargera pas les données Atlas sur votre ordinateur. Le calcul se fera à distance grâce à DuckDB et au format GeoParquet. 
```r
mb <- atlas_rem |> group_by(valid_scientific_name) |> summarize(cnt=count()) |> arrange(desc(cnt)) |> collect()
```

Pour des opérations plus lourdes et une intéraction plus rapide avec le fichier, on peut le télécharger localement sur son ordinateur. Notez que le fichier fait environ 600MB, donc s'assurer d'avoir l'espace disque sur votre ordinateur. 
```r
# Changer le répertoire ~/Downloads pour le répertoire de votre choix sur votre ordinateur
atlas <- atlas_local(tail(atlas_dates$dates,n=1),'~/Downloads/')
```

Charger les observations d'harfang des neiges
```r
bubo <- atlas |> filter(valid_scientific_name == 'Bubo scandiacus') |> collect()
```

Refaire le décompte d'observations par espèce avec le fichier local. Vous verrez que ça se fera plus rapidement qu'avec le fichier à distance. 
```r
sp_count <- atlas |> group_by(valid_scientific_name) |> summarize(cnt=count()) |> arrange(desc(cnt)) |> collect()
```

